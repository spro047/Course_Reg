<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Courses - Course Registration</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h2 class="nav-brand">Course Registration System</h2>
            <div class="nav-user">
                <span>Welcome, <strong><%= userName %></strong></span>
                <a href="/logout" class="btn btn-secondary btn-small">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Semester and Credit Info Section -->
        <div class="info-section">
            <div class="semester-selector">
                <label for="semester-select">Select Semester:</label>
                <select id="semester-select" class="semester-dropdown">
                    <% for(let i = 1; i <= 8; i++) { %>
                        <option value="<%= i %>" <%= semester === i ? 'selected' : '' %>>
                            Semester <%= i %>
                        </option>
                    <% } %>
                </select>
            </div>
            <div class="credit-info">
                <div class="credit-card">
                    <span class="credit-label">Credit Limit:</span>
                    <span class="credit-value"><%= creditLimit %></span>
                </div>
                <div class="credit-card">
                    <span class="credit-label">Registered:</span>
                    <span class="credit-value <%= totalCredits > creditLimit ? 'exceeded' : '' %>"><%= totalCredits %></span>
                </div>
                <div class="credit-card">
                    <span class="credit-label">Remaining:</span>
                    <span class="credit-value <%= remainingCredits < 0 ? 'exceeded' : '' %>"><%= remainingCredits >= 0 ? remainingCredits : 0 %></span>
                </div>
            </div>
        </div>

        <!-- Registered Courses Section -->
        <% if (registeredCourses && registeredCourses.length > 0) { %>
            <div class="section-header">
                <h2>ðŸ“‹ My Registered Courses</h2>
                <p class="section-subtitle">Total: <%= registeredCourses.length %> course(s) â€¢ <%= totalCredits %> credits</p>
            </div>
            <div class="courses-grid">
                <% registeredCourses.forEach(function(course) { %>
                    <div class="course-card registered">
                        <div class="course-header">
                            <h3><%= course.name %></h3>
                            <span class="course-code"><%= course.code %></span>
                        </div>
                        <div class="course-details">
                            <div class="course-info">
                                <span class="badge badge-<%= course.type.toLowerCase() %>"><%= course.type %></span>
                                <span class="credits">Credits: <%= course.credits %></span>
                            </div>
                            <% if (course.semester) { %>
                                <div class="course-semester">Semester: <%= course.semester %></div>
                            <% } %>
                            <button class="btn btn-danger btn-full btn-unregister" data-course-id="<%= course._id %>">
                                Unregister
                            </button>
                        </div>
                    </div>
                <% }); %>
            </div>
        <% } else { %>
            <div class="empty-state">
                <p>No courses registered yet. Browse available courses below and register.</p>
            </div>
        <% } %>

        <!-- Available Courses Section -->
        <div class="section-header">
            <h2>ðŸ“š Available Courses</h2>
            <p class="section-subtitle">Courses sorted by credits (highest first)</p>
        </div>

        <div class="courses-grid">
            <% courses.forEach(function(course) { 
                const isRegistered = registeredCourses.some(rc => rc._id.toString() === course._id.toString());
            %>
                <div class="course-card <%= isRegistered ? 'registered' : '' %>">
                    <div class="course-header">
                        <h3><%= course.name %></h3>
                        <span class="course-code"><%= course.code %></span>
                    </div>
                    <div class="course-details">
                        <div class="course-info">
                            <span class="badge badge-<%= course.type.toLowerCase() %>"><%= course.type %></span>
                            <span class="credits">Credits: <%= course.credits %></span>
                        </div>
                        <% if (course.semester) { %>
                            <div class="course-semester">Semester: <%= course.semester %></div>
                        <% } %>
                        <% if (isRegistered) { %>
                            <button class="btn btn-success btn-full" disabled>
                                âœ“ Registered
                            </button>
                            <button class="btn btn-danger btn-full btn-unregister" data-course-id="<%= course._id %>">
                                Unregister
                            </button>
                        <% } else { %>
                            <button class="btn btn-primary btn-full btn-register" data-course-id="<%= course._id %>" 
                                    <%= (remainingCredits < course.credits) ? 'disabled title="Insufficient credits remaining"' : '' %>>
                                Register Now
                            </button>
                        <% } %>
                    </div>
                </div>
            <% }); %>
        </div>

        <div id="message" class="message"></div>
    </div>

    <script>
        // Update Semester
        document.getElementById('semester-select').addEventListener('change', async function() {
            const semester = this.value;
            try {
                const response = await fetch('/update-semester', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ semester })
                });
                const data = await response.json();
                
                if (data.success) {
                    showMessage('Semester updated successfully. Refreshing...', 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                showMessage('Error updating semester', 'error');
            }
        });

        // Register course
        document.querySelectorAll('.btn-register').forEach(button => {
            button.addEventListener('click', async function() {
                if (this.disabled) return;
                
                const courseId = this.dataset.courseId;
                try {
                    const response = await fetch(`/register-course/${courseId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        showMessage(data.message, 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showMessage(data.message, 'error');
                    }
                } catch (error) {
                    showMessage('Error registering course', 'error');
                }
            });
        });

        // Unregister course
        document.querySelectorAll('.btn-unregister').forEach(button => {
            button.addEventListener('click', async function() {
                const courseId = this.dataset.courseId;
                try {
                    const response = await fetch(`/unregister-course/${courseId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        showMessage(data.message, 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showMessage(data.message, 'error');
                    }
                } catch (error) {
                    showMessage('Error unregistering course', 'error');
                }
            });
        });

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>
